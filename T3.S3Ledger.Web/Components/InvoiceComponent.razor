@page "/invoicecomponent"
@using static T3.S3Ledger.Web.Enums
@inject HttpClient Http
@inject NavigationManager navigation
@inject DialogService dialog

<h3>Customer Bills</h3>

@if (invoices == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <RadzenButton Icon="add_circle_outline" style="margin-bottom: 10px" Text="Add" Click="@InsertRow" />
    <RadzenGrid @ref="invoicesGrid" PagerPosition="PagerPosition.TopAndBottom" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" AllowPaging="true" PageSize="12" RowSelect=@(args => OnRowClick(args)) AllowSorting="true" Data="@invoices" TItem="InvoiceModel" ColumnWidth="100px" Context="invoice">
        <Columns>
            <RadzenGridColumn TItem="InvoiceModel" Title="Customer Name" Property="Customer.CustomerName">
                <Template Context="invoice">
                    @invoice.Customer?.CustomerName
                </Template>
            </RadzenGridColumn>
            <RadzenGridColumn TItem="InvoiceModel" Property="InvoiceDate" Title="Date">
                <Template Context="invoice">
                    @String.Format("{0:ddd, MMM d, yyyy}", invoice.InvoiceDate)
                </Template>
            </RadzenGridColumn>
            <RadzenGridColumn TItem="InvoiceModel" Property="Amount" Title="Invoice Amount" TextAlign="TextAlign.Right">
                <Template Context="invoice">
                    @String.Format("{0:#,##0.##}", invoice.Amount)
                </Template>
            </RadzenGridColumn>
            @*<RadzenGridColumn TItem="InvoiceModel" Context="invoice" Bubble="false" Filterable="false" Sortable="false" TextAlign="TextAlign.Center" Width="100px">
                    <Template Context="invoice">
                        <RadzenButton Icon="edit" Size="ButtonSize.Small" Click="@(args => EditRow(invoice))">
                        </RadzenButton>
                    </Template>
                </RadzenGridColumn>*@
            <RadzenGridColumn TItem="InvoiceModel" Context="invoice" Bubble="false" Filterable="false" Sortable="false" TextAlign="TextAlign.Center" Width="50px">
                <Template Context="invoice">
                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="close" Size="ButtonSize.Small"
                                  Click="@(args => dialog.Confirm("Are you sure?", "Delete Bills", new ConfirmOptions() { OkButtonText = "Yes", CancelButtonText = "No" }))">
                    </RadzenButton>
                </Template>
            </RadzenGridColumn>
        </Columns>
    </RadzenGrid>
}

@code {
    RadzenGrid<InvoiceModel> invoicesGrid;
    List<InvoiceModel> invoices;
    PayMode currentPayMode;
    InvoiceStatus currentPayStatus;

    CustomerModel customer;
    InvoiceModel selectedInvoice;


    dynamic _invoice;
    dynamic invoice
    {
        get
        {
            return _invoice;
        }
        set
        {
            if (_invoice != value)
            {
                _invoice = value;
                StateHasChanged();
            }
        }
    }

    protected async Task OnRowClick(InvoiceModel args)
    {

    }

    protected override async Task OnInitializedAsync()
    {
        invoices = await GetInvoices();
        foreach (var invoice in invoices)
        {
            invoice.Customer = await Http.GetFromJsonAsync<CustomerModel>("/api/customer/" + invoice.CustomerId);
        }
        dialog.OnClose += Close;
    }

    void InsertRow()
    {
        navigation.NavigateTo("/addinvoicecomponent");
    }



    async Task<List<InvoiceModel>> GetInvoices()
    {
        return await Http.GetFromJsonAsync<List<InvoiceModel>>("/api/invoice");
    }


    async void Close(dynamic result)
    {
        if (result)
        {
            selectedInvoice = (InvoiceModel)invoicesGrid.Value;
            CustomerModel custUpdate;
            if (invoices.Contains(selectedInvoice))
            {
                await Http.DeleteAsync("/api/invoice/" + selectedInvoice.Id);
                invoices.Remove(selectedInvoice);

                // update customer
                custUpdate = await Http.GetFromJsonAsync<CustomerModel>("/api/customer/" + selectedInvoice.CustomerId);
                custUpdate.TotalInvoicedAmount = custUpdate.TotalInvoicedAmount.HasValue ? custUpdate.TotalInvoicedAmount : 0;
                custUpdate.TotalOutstandingAmount = custUpdate.TotalOutstandingAmount.HasValue ? custUpdate.TotalOutstandingAmount : 0;
                custUpdate.TotalInvoicedAmount -= selectedInvoice.Amount;
                custUpdate.TotalOutstandingAmount -= selectedInvoice.Amount;
                await Http.PutAsJsonAsync<CustomerModel>("/api/customer", custUpdate);
                await invoicesGrid.Reload();
            }
        }
    }

    void EditRow(InvoiceModel invoice)
    {
        navigation.NavigateTo("/editinvoicecomponent/" + invoice.Id);
    }

}
